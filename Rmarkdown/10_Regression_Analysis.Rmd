---
title: "10_Regression_analysis"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### 1. Load packages, set working directory, and prevent scientific notation
```{r get_packages, message=FALSE, warning=FALSE}
library(tidyverse)
library(rgdal)
library(sf)
library(MatchIt) ## Package with Propensity Score Matching
library(optmatch)
options(scipen = 9999) ## Avoid scientific notation
setwd("~/Desktop/Organics_Final/Working/organics_repo/") # Set working directory to make relative filepath names work

```

Simple linear regression equation

$Annual~kg/H = croptype + CDFA~organic + field~size + soil~quality$

#### 2. Prepare regression dataframe

# Get data and make a dataframe to be used in regression analysis. 
This is not important, it just gets rid of '-ORGANIC' from the commodity column and groups lettuce together, rather than having 'LETTUCE LEAF' and 'LETTUCE' as separate crop types. 
```{r get_data, echo=TRUE, message=FALSE, warning=FALSE}

data = readOGR("../R_output/spatial/final_organics_data/cdfa_organics.shp") %>% 
  st_as_sf()

matching = data %>% 
     as.data.frame() %>% 
     dplyr::select(-geometry) %>% 
     group_by(comm_dt) %>% 
     summarise(total_fields = n(),
               organic_fields = sum(organic),
               conv_fields = n()-sum(organic)) %>% 
  filter(organic_fields > 9 & conv_fields > 9) %>% 
  arrange(-organic_fields)

common_crops = as.factor(as.character(matching$comm_dt))
org_groups = as.factor(as.character(data$cmm_grp[data$organic==1]))

comm_regression_df = data %>% 
  as.data.frame() %>% 
  filter(soil_q > 0 & comm_dt%in%common_crops) %>% 
  dplyr::select(permtst,
         permitt,
         "croptype" = comm_dt,
         organic,
         soil_q,
         KgPstAI,
         kgperhc,
         hectars)

commgroup_regression_df = data %>% 
  as.data.frame() %>% 
  filter(soil_q>0 & cmm_grp%in%org_groups) %>% 
  dplyr::select("group" = cmm_grp,
         "croptype"=comm_dt,
         organic,
         soil_q,
         KgPstAI,
         kgperhc,
         hectars)
```

# Data Exploration
```{r data_explore}

ggplot(comm_regression_df, aes(x = organic, y = soil_q))+
  geom_point()+
  geom_line()

ggplot(filter(comm_regression_df, ), aes(x = organic, y = hectars))+
  geom_point()+
  geom_line()

```


# Simple Linear Regression -- Just seeing how R is recognizing/processing covariates
```{r SLR}
## On individual crop types

simple_indv_reg = lm(kgperhc~croptype+organic+soil_q+hectars, data = comm_regression_df) # Mainly to see how data is being read in regression
summary(simple_indv_reg) # Look at regression results

field_soil_lm = lm(soil_q~hectars, data=comm_regression_df)
summary(field_soil_lm)

## On broad commodity groups

simple_grp_reg = lm(kgperhc~group+organic+soil_q+hectars, data = commgroup_regression_df) # Mainly to see how data is being read in regression
summary(simple_grp_reg) # Look at regression results

field_soil_lm = lm(soil_q~hectars, data=comm_regression_df)
summary(field_soil_lm)
```

# Propensity score estimation for dataset with Crop reference variable
```{r estimate_scores}

propensity_logit = glm(organic ~ croptype + soil_q, 
                       family = binomial, 
                       data = comm_regression_df)

summary(propensity_logit)

# Predict propensity scores and place in a new column
pscore_df = data.frame(pr_score = predict(propensity_logit,type = "response"),
                    organic = comm_regression_df$organic)

```

# Look at propensity score distribution
```{r}
ggplot(pscore_df,aes(x = pr_score))+
  geom_histogram(color="white",bins=15)+
  facet_wrap(~organic,scales="free")+
  theme_bw()
```


# Propensity score matching
```{r find_matches}
# The following paragraph is the MatchIt package author's explanation of the matchit() function that I use below

# matchit is the main command of the package MatchIt, which enables parametric models for causal inference to work better by selecting well-matched subsets of the original treated and control groups. MatchIt implements the suggestions of Ho, Imai, King, and Stuart (2004) for improving parametric statistical models by preprocessing data with nonparametric matching methods. MatchIt implements a wide range of sophisticated matching methods, making it possible to greatly reduce the dependence of causal inferences on hard-to-justify, but commonly made, statistical modeling assumptions. The software also easily fits into existing research practices since, after preprocessing with MatchIt, researchers can use whatever parametric model they would have used without MatchIt, but produce inferences with substantially more robustness and less sensitivity to modeling assumptions. 

match = matchit(organic ~ croptype + soil_q, 
                method = "nearest", 
                data = comm_regression_df,
                reestimate = T,
                discard = "control")

# summary(match)
plot(match)

# match.data outputs matched data sets from matchit()
matches <- match.data(match)
dim(matches)
```


Look at difference in means between matches to see if they're closer than in the original data set. 
- Differences should not be significant AKA fail to reject the null
```{r check_matches}
cov <- c( 'soil_q') # Covariates to check matches with

matches %>%
  group_by(organic) %>% # Seperate the two CDFA groups (1 = ORGANIC, 0 = CONVENTIONAL)
  dplyr::select(one_of(cov)) %>%
  summarise_all(funs(mean))  # Find the means of each covariate group within the org or conv groups

t.test(matches$soil_q~matches$organic)
t.test(matches$hectars~matches$organic)

# Checking another way
ggplot(matches,aes(x = distance,y = soil_q,color=organic))+
  geom_point()+
  geom_smooth(method = "loess")+
  theme_bw()

ggplot(matches,aes(x = distance,y = hectars,color=organic))+
  geom_point()+
  geom_smooth(method = "loess")+
  theme_bw()

ggplot(matches,aes(x = distance,y = croptype,color=organic))+
  geom_point()+
  theme_bw()
```


# THE TWO PROPENSITY SCORE REGRESSION EQUATIONS
************
## Regression with **propensity scores as covariate**
```{r reg_with_pscores}

comm_regression_df$pscores = predict.glm(propensity_logit,type="response")
comm_regression_filter = comm_regression_df %>% 
  filter(pscores > 0.3 & pscores < 0.7)

pscore_reg = lm(kgperhc ~ croptype + organic + hectars + soil_q + pscores, data = comm_regression_filter)
summary(pscore_reg)

plot(pscore_reg)
```


************
## Regression on **matches data.frame**, *propensity score not used as covariate*
```{r match_regression}

matches_filter = matches %>% 
  filter(distance > .1 & distance <.9)

matches_reg = lm(kgperhc ~ croptype + organic + hectars + soil_q , data = matches_filter)
summary(matches_reg)

plot(matches_reg)

```


** Producers that have both organic and conventional
- Isolate to farmers who grow both and compare pesticide use 
- How to do the stats on this




