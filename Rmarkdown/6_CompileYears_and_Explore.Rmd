---
title: "6 Compile data and explore"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**The purpose of this Rmarkdown file is to compile the finalized datasets for all years, and write output tabular and shapefiles**  

**Output:**
- ../R_output/CSV/compiled_organics1319.dta
- ../R_output/CSV/compiled_organics1319.csv
- ../R_output/spatial/final_organics_data/all_years/all_years_organics.shp

---

#### 1. Get Packages, set working directory, etc. 
```{r packages}
library(tidyverse)
library(rgdal)
library(sf)
library(haven)

# Read in pesticide use data
pest_data_raw = read_dta("../R_input/dta/KernFieldCrops1319.dta") %>% 
  as.data.frame()

#Reading in Ashley result dta to create shapefile for spatial maps for paper
mpdata = read_dta("../R_input/dta/organicAnalysisPUR.dta") %>% as.data.frame()

#Crosswalk for yield gaps excel sheet
yieldclass<-mpdata %>% dplyr::select(agroclass) %>% distinct()
write_csv(yieldclass, "../R_output/CSV/yieldgapcrosswalk/agroclasses.csv")
  
map_data<-mpdata %>% filter(year==2019) %>% dplyr::select(permitsite, year, hectares, soil_quality, comm_edit, comm_code2, KgPestAI, KgPestPrd)%>% dplyr::mutate(KgPestAIha=KgPestAI/hectares, KgPestPrdha=KgPestPrd/hectares) %>% dplyr::select(-KgPestAI, -KgPestPrd)

kernfields_2019<-read_sf("../R_input/spatial/kern_AG_shp/kern2019/kern2019.shp") %>% dplyr::select(PMT_SITE) %>% dplyr::rename(permitsite=PMT_SITE)

top15crops<- map_data %>% dplyr::select(permitsite, comm_code2) %>% group_by(comm_code2) %>% summarize(count=n()) %>% 
  arrange(-count) %>% dplyr::mutate(Order=1:nrow(.)) %>% ungroup() %>% 
  full_join(map_data, by="comm_code2") %>% dplyr::mutate(comm=tolower(ifelse(Order<=15, comm_edit, "Other")))%>% 
  dplyr::select(comm_edit, comm, comm_code2) %>% distinct() %>% 
  dplyr::mutate(comm=ifelse(comm_code2==29141, "grape", comm),
                comm=ifelse(comm_code2==2008, "tangerine", comm))
  #Make Grape and tangerine with same comm code have same comm edit

mapdf<-full_join(map_data, kernfields_2019, by="permitsite") %>% 
  full_join(top15crops, by=c("comm_edit", "comm_code2"))%>% st_as_sf()

write_sf(mapdf, "../R_output/spatial/map_data/mapdf.shp", delete_layer = TRUE)


```

#### 2. Read in finalized data (shapefile) for each year, and turn into dataframe to rbind in next chunk
```{r data}

years = 2013:2019

## Read in shapefiles and make into a simple data.frame without geometry
for(i in years){
  
  tmp = read_sf(paste0("../R_output/spatial/final_organics_data/",i,"/all_organics_pest_",i,".shp")) 
  
  assign(paste0("organics_df_",i),tmp)
  
  rm(tmp)
  
}

```

#### 3. Redo agroclass join to 2019
```{r fix_2019_agroclassJoin}

##### Fix the rows with '-' at the end of the comm column #####

# Convert comm_edit column from factor to character
organics_df_2019$comm_dt=as.character(organics_df_2019$comm_dt)

# Separate edited comm column (comm_dt) by dash
organics_df_2019 = organics_df_2019 %>%
    separate(col = "comm_dt",
             into = c("COMM_x","COMM_y"),
             sep = "-",
             remove = FALSE)

# Get rid of '-' where it exists at the end of commodity strings
organics_df_2019$comm_dt = ifelse((organics_df_2019$COMM_y==""| # If there is a 0 , "", or NA in the comm_y column from above
                                     organics_df_2019$COMM_y=="O"|
                                     is.na(organics_df_2019$COMM_y)),
                                  organics_df_2019$COMM_x, # Then comm equals the value in comm_x
                                  organics_df_2019$comm_dt) # Otherwise it equals the comm_dt column as is

## Read in agroclass data
agro_class <- read_csv("../R_input/CSV/Kern_AG/comm_subgroups.csv")

## Find 2019 rows that have NA in the agroclass column
missing_agrcls = filter(organics_df_2019,is.na(agrclss))
# 218 before

## Rejoin 2019 dataframe with updated comm column to agroclass data.set
organics_df_2019 = left_join(x = organics_df_2019,y = agro_class, by = c("comm_dt" = "commodity"))

# See how many still have NA values
missing_agrcls = filter(organics_df_2019,is.na(agroclass))
# 141 after

# Look at what crop types have NA values
data.frame(table(organics_df_2019$comm_dt[is.na(organics_df_2019$agroclass)])) %>% 
  arrange(-Freq)

# 
organics_df_2019 = organics_df_2019 %>% 
  dplyr::select(permtst,
                permit,
                s_stats,
                p_stats,
                permitt,
                commdty,
                comm_cd,
                "agrclss" = agroclass, 
                "genus" = genus.y, 
                "family" = family.y, 
                comm_dt,
                acres,soil_q,
                apn,trs_nly,
                trs_rgP,
                cdf_rgn,
                comm_rg,
                prmtt_r,
                all_rgn,
                year,
                permitn,
                locatin,
                N_crps_,
                hectars, 
                geometry)

# Check that columns are in the same order and have the same names are other years, for the rbind
colnames(organics_df_2013) == colnames(organics_df_2019)
```

#### 4. CSV OUTPUT: Compile (rbind) years into one df
```{r compile_for_csv}

# Initiate dataframe using 2013 dataset
all_years_df <- data.frame(matrix(ncol=ncol(organics_df_2013)-1,nrow=0))

# Rename columns to match 2013 dataset
colnames(all_years_df) <- colnames(organics_df_2013)[1:ncol(organics_df_2013)-1]

# Rbind all years
for(i in years){
  
  # Dataframe for year i
  tmp <- eval(as.name(paste0("organics_df_",i))) %>% 
    as.data.frame() %>% 
    dplyr::select(-geometry)
  
  # Fill in year column 
  tmp$year = i
  
  # Rbind to final dataframe
  all_years_df = rbind(all_years_df,tmp)
  
  # Remove tmp data.frame
  remove(tmp)
  
}

# Look at number of rows for each year
table(all_years_df$year)
# 2013  2014  2015  2016  2017  2018  2019 
# 13997 13906 14057 14017 14287 14431 14841 

## Rename columns with full names
colnames(all_years_df) = c("permitsite","ag_permit","s_status","p_status","permittee","comm_original","comm_code","agroclass","genus","family",
                           "comm_edit","acres","soil_quality","apn_org","trsonly_org","trspermittee_org","cdfa_org","kerncomm_org","kernpermittee_org",
                           "all_org","year","pur_permit","pur_site","n_crops","hectares")

# Write output dta and csv files
write_dta(all_years_df, "../R_output/CSV/compiled_organics1319.dta")
write_csv(all_years_df, "../R_output/CSV/compiled_organics1319.csv")

```

#### 5. Do the same as above without removing geometry then compile into single shapefile
```{r compile_for_shp}

# Initiate dataframe using 2013 dataset
all_years_shp <- organics_df_2013
all_years_shp$year = 2013 # Fill in year

# Years to loop through
years = 2014:2019 

for(i in years){
  
  # Get dataframe for year i
  tmp <- eval(as.name(paste0("organics_df_",i)))
  
  # Fill in year
  tmp$year = i
  
  # R bind to compiled dataset
  all_years_shp = rbind(all_years_shp,tmp)
  
  # Remove tmp dataframe
  remove(tmp)
  
}

# Check the number of rows in each year
table(all_years_shp$year)

# Rename columns
colnames(all_years_shp) = c("permitsite","ag_permit","s_status","p_status","permittee","comm_original","comm_code","agroclass","genus","family",
                           "comm_edit","acres","soil_quality","apn_org","trsonly_org","trspermittee_org","cdfa_org","kerncomm_org","kernpermittee_org",
                           "all_org","year","pur_permit","pur_site","n_crops","hectares", "geometry")

# Write output shapefile
writeOGR(as(all_years_shp,"Spatial"),
         dsn = "../R_output/spatial/final_organics_data/all_years",
         layer = "all_years_organics",
         driver = "ESRI Shapefile",
         overwrite_layer = T)
```


#### 5. Visualize some data 

Organics per year
```{r orgs_per_year}

org_fields_perYear = all_years_df %>% 
  group_by(year) %>% 
  summarise(cdfa_organics = sum(cdfa_org),
            all_organics = sum(all_org))

ggplot(org_fields_perYear, aes(x = as.factor(year), y = cdfa_organics, fill = as.factor(year)))+
  geom_col()+
  geom_label(aes(label = cdfa_organics))+
  theme_classic()

ggplot(org_fields_perYear,aes(x = as.factor(year),y = all_organics,fill = as.factor(year)))+
  geom_col()+
  geom_label(aes(label = all_organics))+
  theme_classic()
```

Field size (hectares) -- Get into same figure
```{r field_size}
mean_hectares = all_years_df %>% 
  group_by(year,cdfa_org) %>% 
  summarise(mean_hectares = round(mean(hectares),2))

ggplot(mean_hectares,aes(x = year,y = mean_hectares,fill=as.factor(cdfa_org)))+
  geom_col(position = "dodge")+
  # geom_label(aes(label = mean_hectares)) + 
  theme_classic()+
  scale_fill_manual(values = c("darkgoldenrod2", "#2e4057"), labels = c("Conventional","Organic"))+
  scale_x_continuous(breaks = c(2013:2019))+
  xlab("Year")+
  ylab("Average Field Size (hectares)")+
  theme(legend.title = element_blank())

ggplot(mean_hectares, aes(x = year, y = mean_hectares))+
  geom_line(aes(colour = as.factor(cdfa_org)), size = 1)+
  geom_point(aes(colour = as.factor(cdfa_org)), size = 3)+
  theme_classic()+
  scale_colour_manual(values = c("darkgoldenrod2", "#2e4057"), labels = c("Conventional","Organic"))+
  scale_x_continuous(breaks = c(2013:2019))+
  xlab("Year")+
  ylim(10,40)+
  ylab("Average Storie Index Soil Quality Rating \n [1 = highest]")+
  theme(legend.title = element_blank())
```

Soil Quality
```{r soilQuality}

mean_soilQ = all_years_df %>% 
  group_by(year,cdfa_org) %>% 
  summarise(mean_soilQ = round(mean(soil_quality, na.rm=T),2))

# ggplot(mean_soilQ,aes(x = year,y = mean_soilQ,fill=as.factor(cdfa_org)))+
#   # geom_col(position = "dodge")+
#   # geom_label(aes(label = mean_hectares)) + 
#   theme_classic()+
#   scale_fill_manual(values = c("darkgoldenrod2", "#2e4057"), labels = c("Conventional","Organic"))+
#   scale_x_continuous(breaks = c(2013:2019))+
#   xlab("Year")+
#   ylab("Average Storie Index Soil Quality Rating \n [1 = highest]")+
#   theme(legend.title = element_blank())

# ggplot(all_years_df,aes(x = as.factor(cdfa_org),y = soil_quality))+
#   geom_violin()+
#   theme_classic()+
#   facet_wrap(~year)

ggplot(mean_soilQ, aes(x = year, y = mean_soilQ))+
  geom_line(aes(colour = as.factor(cdfa_org)), size = 1)+
  geom_point(aes(colour = as.factor(cdfa_org)))+
  theme_classic()+
  scale_colour_manual(values = c("darkgoldenrod2", "#2e4057"), labels = c("Conventional","Organic"))+
  scale_x_continuous(breaks = c(2013:2019))+
  xlab("Year")+
  ylim(1,3)+
  ylab("Average Storie Index Soil Quality Rating \n [1 = highest]")+
  theme(legend.title = element_blank())
```


#### 6. Check out pesticide use data
```{r pesticide}
#Pesticide data removed from dta

# explore_pst_use = all_years_df %>% 
#   group_by(cdfa_org,year) %>% 
#   summarise(avg_kg_pest_ai = round(mean(KgPestAI),2), # should adjust this for number of fields
#             avg_kg_ai_perHec = round(mean(KgAIperHE),2))
# 
# ggplot(explore_pst_use,aes(x = as.factor(year), y = avg_kg_pest_ai, fill = as.factor(year)))+
#   geom_col()+
#   geom_label(aes(label = avg_kg_ai_perHec))+
#   facet_wrap(~cdfa_org)+
#   theme_classic()

```

