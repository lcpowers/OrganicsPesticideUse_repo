---
title: "6 Compile data and explore"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### 1. Get Packages, set working directory, etc. 
```{r packages}
library(tidyverse)
library(rgdal)
library(sf)

# setwd("~/Projects/Organics/Working/organics_repo/Rmarkdown/")
pest_data_raw = read_dta("../R_input/dta/KernFieldCrops1319.dta") %>% 
  as.data.frame()
```

#### 2. Read in data (shapefile) for each year, and turn into df to rbind in next chunk
```{r data}

years = 2013:2019

## Read in shapefiles and make into a simple data.frame without geometry
for(i in years){
  
  tmp = read_sf(paste0("../R_output/spatial/final_organics_data/",i,"/all_organics_pest_",i,".shp")) 
  
  assign(paste0("organics_df_",i),tmp)
  
  rm(tmp)
  
}

```

# Redo agroclass join to 2019
```{r fix_2019_agroclassJoin}

# Convert comm_edit column from factor to character
organics_df_2019$comm_dt=as.character(organics_df_2019$comm_dt)

# Fix the rows with '-' at the end of the comm column. 2019 is the worst
organics_df_2019 = organics_df_2019 %>%
    separate(col = "comm_dt",
             into = c("COMM_x","COMM_y"),
             sep = "-",
             remove = FALSE)

# Get rid of '-' where it exists at the end of commodity strings
organics_df_2019$comm_dt = ifelse((organics_df_2019$COMM_y==""|organics_df_2019$COMM_y=="O"|is.na(organics_df_2019$COMM_y)),organics_df_2019$COMM_x,organics_df_2019$comm_dt)

## Fix 2019 commcode/agroclass issue, which seems to mainly result from the weird, truncated -ORGANIC in some columns. Just join the two based on comm_edit
agro_class <- read_csv("../R_input/CSV/Kern_AG/comm_subgroups.csv")
missing_agrcls = filter(organics_df_2019,is.na(agrclss))
# 218 before

organics_df_2019 = left_join(x = organics_df_2019,y = agro_class, by = c("comm_dt" = "commodity"))
missing_agrcls = filter(organics_df_2019,is.na(agroclass))
# 141 after

data.frame(table(organics_df_2019$comm_dt[is.na(organics_df_2019$agroclass)])) %>% 
  arrange(-Freq)

organics_df_2019 = organics_df_2019 %>% 
  dplyr::select(permtst,permit,s_stats,p_stats,permitt,commdty,comm_cd,
                "agrclss" = agroclass, "genus" = genus.y, "family" = family.y,comm_dt,
                acres,soil_q,apn,trs_nly,trs_rgP,cdf_rgn,comm_rg,
                prmtt_r,all_rgn,year,permitn,locatin,N_crps_,hectars, geometry)

# Check that columns are in the same order and have the same names are other years, for the rbind
colnames(organics_df_2013) == colnames(organics_df_2019)
```

#### 3. CSV OUTPUT: Compile (rbind) years into one df
```{r compile_for_csv}

all_years_df <- data.frame(matrix(ncol=ncol(organics_df_2013)-1,nrow=0))
colnames(all_years_df) <- colnames(organics_df_2013)[1:ncol(organics_df_2013)-1]

for(i in years){
  
  tmp <- eval(as.name(paste0("organics_df_",i))) %>% 
    as.data.frame() %>% 
    dplyr::select(-geometry)
  
  tmp$year = i
  
  all_years_df = rbind(all_years_df,tmp)
  
  remove(tmp)
  
}

# Check
table(all_years_df$year)
# 2013  2014  2015  2016  2017  2018  2019 
# 13997 13906 14057 14017 14287 14431 14841 

### This should throw an error because it's not enough column names. Need to add in P_status wherever it ends up.
colnames(all_years_df) = c("permitsite","ag_permit","s_status","p_status","permittee","comm_original","comm_code","agroclass","genus","family",
                           "comm_edit","acres","soil_quality","apn_org","trsonly_org","trspermittee_org","cdfa_org","kerncomm_org","kernpermittee_org",
                           "all_org","year","pur_permit","pur_site","n_crops","hectares")

write_dta(all_years_df, "../R_output/CSV/compiled_organics1319.dta")
write_csv(all_years_df, "../R_output/CSV/compiled_organics1319.csv")
```

#### Do the same as above without removing geometry then compile into single shapefile
```{r compile_for_shp}

years = 2013:2019

all_years_shp <- organics_df_2013
all_years_shp$year = 2013
years = 2014:2019

for(i in years){
  
  tmp <- eval(as.name(paste0("organics_df_",i)))
  
  tmp$year = i
  
  all_years_shp = rbind(all_years_shp,tmp)
  
  remove(tmp)
  
}

# Check
table(all_years_shp$year)

colnames(all_years_shp) = c("permitsite","ag_permit","s_status","p_status","permittee","comm_original","comm_code","agroclass","genus","family",
                           "comm_edit","acres","soil_quality","apn_org","trsonly_org","trspermittee_org","cdfa_org","kerncomm_org","kernpermittee_org",
                           "all_org","year","pur_permit","pur_site","n_crops","hectares", "geometry")

writeOGR(as(all_years_shp,"Spatial"),
         dsn = "../R_output/spatial/final_organics_data/all_years",
         layer = "all_years_organics",
         driver = "ESRI Shapefile",
         overwrite_layer = T)
```


#### 5. Visualize some data

Organics per year
```{r orgs_per_year}

org_fields_perYear = all_years_df %>% 
  group_by(year) %>% 
  summarise(cdfa_organics = sum(cdfa_org),
            all_organics = sum(all_org))

ggplot(org_fields_perYear, aes(x = as.factor(year), y = cdfa_organics, fill = as.factor(year)))+
  geom_col()+
  geom_label(aes(label = cdfa_organics))+
  theme_classic()

ggplot(org_fields_perYear,aes(x = as.factor(year),y = all_organics,fill = as.factor(year)))+
  geom_col()+
  geom_label(aes(label = all_organics))+
  theme_classic()
```

Field size (hectares)
```{r field_size}
mean_hectares = all_years_df %>% 
  group_by(year,cdfa_org) %>% 
  summarise(mean_hectares = round(mean(hectares),2))

ggplot(mean_hectares,aes(x = as.factor(cdfa_org),y = mean_hectares,fill=as.factor(cdfa_org)))+
  geom_col()+
  geom_label(aes(label = mean_hectares))+
  facet_wrap(~year)

```

Soil Quality
```{r soilQuality}

mean_hectares = all_years_df %>% 
  group_by(year,cdfa_org) %>% 
  summarise(mean_soilQ = round(mean(soil_quality, na.rm=T),2))

ggplot(mean_hectares,aes(x = as.factor(cdfa_org),y = mean_soilQ,fill=as.factor(cdfa_org)))+
  geom_col()+
  geom_label(aes(label = mean_soilQ))+
  facet_wrap(~year)
```



#### 6. Check out pesticide use data
```{r pesticide}
#Pesticide data removed from dta

# explore_pst_use = all_years_df %>% 
#   group_by(cdfa_org,year) %>% 
#   summarise(avg_kg_pest_ai = round(mean(KgPestAI),2), # should adjust this for number of fields
#             avg_kg_ai_perHec = round(mean(KgAIperHE),2))
# 
# ggplot(explore_pst_use,aes(x = as.factor(year), y = avg_kg_pest_ai, fill = as.factor(year)))+
#   geom_col()+
#   geom_label(aes(label = avg_kg_ai_perHec))+
#   facet_wrap(~cdfa_org)+
#   theme_classic()

```

