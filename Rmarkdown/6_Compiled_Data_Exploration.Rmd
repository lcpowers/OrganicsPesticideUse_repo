---
title: "Explore compiled shapefile attribute table"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**The purpose of this Rmarkdown file is to do some initial exploration of pesticide use by crop type, and look for fishy observations that can either be adjusted or removed.**  

**Notes:**
- 

**Output:**
- 

---

#### 1. Load packages and cdfa_orgs
```{r cdfa_orgs_packages}

library(tidyverse)
library(rgdal)
library(sf)

setwd("~/Desktop/Organics_Final/Working/organics_repo/Rmarkdown/")

# CDFA Organics
cdfa_orgs = readOGR("../R_output/spatial/final_organics_data/cdfa_organics.shp") %>% 
  st_as_sf() 

## Number of organic observations with TRS = 682
sum(cdfa_orgs$organic)

## Number of organic observations without TRS = 331
sum(cdfa_orgs$apn_mtc)

# CDFA and Kern Ag Organics
cdfa_kern_orgs = cdfa_orgs 
cdfa_kern_orgs$permtst <- as.factor(cdfa_kern_orgs$permtst)
cdfa_kern_orgs$organic = ifelse(cdfa_kern_orgs$apn_mtc==1|cdfa_kern_orgs$trs_mtc==1|str_detect(cdfa_kern_orgs$comm,"ORGANIC"),1,0)  

# Number of organic observations with APN, TRS, and Kern Ag Commodity with "-ORGANIC"
sum(cdfa_kern_orgs$organic)
# 741 with only str_detect 1 permtst org
# 750 with str_detect 1 and 2
# 764 with all 3 str detect


# WRite this output file for later use
writeOGR(as(cdfa_kern_orgs,"Spatial"),
         dsn = "../R_output/spatial/final_organics_data/",
         layer = "cdfa_with_KernAg_organics",
         driver = "ESRI Shapefile",
         overwrite_layer = T)

```


# Explore cdfa_orgs by crop type and organic/conventional
```{r find_top_crops}
topCrops_df = cdfa_orgs %>% 
  as.cdfa_orgs.frame() %>% # Convert to cdfa_orgs.frame
  dplyr::select(-geometry) %>% # Remove geometry column
  group_by(comm_dt) %>% # Group by COMM column
  summarise(total_orgFields = sum(organic)) %>% # Sum the organic column. This tells us how many organic fields of each crop type there are
  arrange(-total_orgFields)

comparison_crops = subset(topCrops_df, total_orgFields>10) %>%  # Create a new vector with names of crops with at least five fields
  dplyr::select(1) 

comparison_crops = comparison_crops$comm_dt
comparison_crops # Display in an Rmarkdown document

cdfa_orgs$KgAIperHe = cdfa_orgs$KgPstAI/cdfa_orgs$hectars
## 8531 observations before excluding outliers
```

# Look for outliers in CDFA organic crops

## All crops combined
```{r all_crops_outliers}

par(mfrow=c(2,3))
hist(cdfa_orgs$KgAIperHe[cdfa_orgs$organic==1],
    main = "orgs",
    breaks = 30,
    xlab = "")

qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$organic==1],main = "orgs")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$organic==1],main="orgs")

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$organic==0],
    main = "conv",
    breaks = 30,
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$organic==0],main = "conv")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$organic==0],main="conv")

```


## By Crop Type
```{r by_crop_outliers}
# Organic
ggplot(subset(cdfa_orgs,organic == 1&COMM_nw%in%comparison_crops), aes(x = KgAIperHe))+
  geom_histogram()+
  facet_wrap(~COMM_nw,scales = "free")+
  theme_bw()

ggplot(subset(cdfa_orgs,organic == 1&COMM_nw%in%comparison_crops), aes(sample  = KgAIperHe)) +
  geom_qq() +
  facet_wrap(~COMM_nw,scales = "free") +
  theme_bw()

# Conventional
ggplot(subset(cdfa_orgs,organic == 0), aes(x = KgAIperHe))+
  geom_histogram()+
  facet_wrap(~COMM_nw,scales = "free")+
  theme_bw()

ggplot(subset(cdfa_orgs,organic == 0), aes(sample  = KgAIperHe)) +
  geom_qq() +
  facet_wrap(~COMM_nw,scales = "free") +
  theme_bw()
```

### CARROTS
```{r carrots}
crop = 'CARROT'

par(mfrow = c(2,3))

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw == crop &cdfa_orgs$organic==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
       main = "orgs")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
        main="orgs")

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
       main = "conv")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
        main = "conv")

# Remove carrot outliers
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 1 & cdfa_orgs$KgAIperHe>1000 & cdfa_orgs$COMM_nw == crop),]

## 8529
```

### CABBAGE
```{r cabbage}
crop = 'CABBAGE'

par(mfrow = c(2,3))

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw == crop &cdfa_orgs$organic==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
       main = "orgs")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
        main="orgs")

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
       main = "conv")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
        main = "conv")

# Remove carrot outliers
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 1 & cdfa_orgs$KgAIperHe>8 & cdfa_orgs$COMM_nw == "CABBAGE"),]
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 0 & cdfa_orgs$KgAIperHe>20 & cdfa_orgs$COMM_nw == "CABBAGE"),]

# 8527
```

### ORANGES
```{r oranges}
crop = 'ORANGE'

par(mfrow = c(2,3))

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw == crop &cdfa_orgs$organic==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
       main = "orgs")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
        main="orgs")

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
       main = "conv")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
        main = "conv")

# Remove Lemon outliers
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 1 & cdfa_orgs$KgAIperHe>200 & cdfa_orgs$COMM_nw == "ORANGE"),]
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 0 & cdfa_orgs$KgAIperHe>500 & cdfa_orgs$COMM_nw == "ORANGE"),]

# 8524
```


### GARLIC
```{r garlic}
crop = 'GARLIC'

par(mfrow = c(2,3))

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw == crop &cdfa_orgs$organic==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
       main = "orgs")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
        main="orgs")

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
       main = "conv")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
        main = "conv")

# Remove GARLIC outliers
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 1 & cdfa_orgs$KgAIperHe>60 & cdfa_orgs$COMM_nw == "GARLIC"),]
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 0 & cdfa_orgs$KgAIperHe>15 & cdfa_orgs$COMM_nw == "GARLIC"),]

```


### SPINACH
```{r spinach}
crop = 'SPINACH'

par(mfrow = c(2,3))

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw == crop &cdfa_orgs$organic==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
       main = "orgs")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
        main="orgs")

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
       main = "conv")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
        main = "conv")

# Remove Lemon outliers
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 1 & cdfa_orgs$KgAIperHe>50 & cdfa_orgs$COMM_nw == "SPINACH"),]

```

### LETTUCE LEAF
```{r lettuce}
crop = 'LETTUCE'

par(mfrow = c(2,3))

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw == crop & cdfa_orgs$organic==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
       main = "orgs")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
        main="orgs")

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
       main = "conv")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
        main = "conv")

# Remove Lettuce outliers
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 1 & cdfa_orgs$KgAIperHe>60 & cdfa_orgs$COMM_nw == "LETTUCE"),]
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 0 & cdfa_orgs$KgAIperHe>60 & cdfa_orgs$COMM_nw == "LETTUCE"),]

```

### GRAPES
```{r grape}
crop = 'GRAPE'
par(mfrow = c(2,3))

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw == crop &cdfa_orgs$organic==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
       main = "orgs")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
        main="orgs")

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
    main = "conv",
    breaks = 30,
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
       main = "conv")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
        main = "conv")


```

### POTATO
```{r potato}
crop = 'POTATO'
par(mfrow = c(2,3))

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw == crop &cdfa_orgs$organic==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
       main = "orgs")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==1],
        main="orgs")

hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
    main = "conv",
    breaks = 30,
    xlab = "")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
       main = "conv")
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_nw==crop&cdfa_orgs$organic==0],
        main = "conv")

# Remove potato outliers
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 1 & cdfa_orgs$KgAIperHe>15 & cdfa_orgs$COMM_nw == "POTATO"),]
# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 0 & cdfa_orgs$KgAIperHe>1500 & cdfa_orgs$COMM_nw == "POTATO"),]

```

# Explore cdfa_orgs by COMM_grp
```{r comm_group_outliers}

# Fruit
group = "FRUIT"

par(mfrow=c(2,3))
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")
hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")

boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")
hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")

# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 1 & cdfa_orgs$KgAIperHe>1500 & cdfa_orgs$COMM_GR == "FRUIT"),]

# Vegetables
group = "VEGETABLE"

par(mfrow=c(2,3))
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")
hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")

boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")
hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")

# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 1 & cdfa_orgs$KgAIperHe>400 & cdfa_orgs$COMM_GR == "VEGETABLE"),]


# CITRUS
group = "CITRUS"

par(mfrow=c(2,3))
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")
hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")

boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")
hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")

# cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 0 & cdfa_orgs$KgAIperHe>400 & cdfa_orgs$COMM_GR == "CITRUS"),]


# NUTS
group = "NUTS"

par(mfrow=c(2,3))
boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")
hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==0], main = "conv")

boxplot(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")
qqnorm(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")
hist(cdfa_orgs$KgAIperHe[cdfa_orgs$COMM_GR==group&cdfa_orgs$organic==1], main = "org")

```

## Remove cases from conventional fields that seem fishy because the word "Organic" is indiciated somewhere in the name.
```{r fishy_conventional}

cdfa_orgs$PERMITT = as.character(cdfa_orgs$PERMITT) # Put the Permittee column in character format
cdfa_orgs = cdfa_orgs[!(cdfa_orgs$organic == 0&str_detect(cdfa_orgs$PERMITT,"ORGANIC")),] # Remove observations that contain the word "organic" in the permittee column

```


## Write output shapefile
```{r write_output}

cdfa_orgs_shp = as(cdfa_orgs,"Spatial")

writeOGR(cdfa_orgs_shp,
           "../R_output/spatial/KernAg_organic_pest/2017/FINAL",
           "KernAg_organic_Pest_FINAL",
           driver = "ESRI Shapefile",
           overwrite_layer = TRUE)

```

