---
title: "Explore compiled shapefile attribute table"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**The purpose of this Rmarkdown file is to do some initial exploration of pesticide use by crop type, and look for fishy observations that can either be adjusted or removed.**  

**Notes:**
- 

**Output:**
- 

---

#### 1. Load packages and data
```{r data_packages}

library(tidyverse)
library(rgdal)
library(sf)

setwd("~/Desktop/Organics_Final/Working/R_files/Rmarkdown/")

datawithTRS = readOGR("../R_output/spatial/KernAg_CDFA_pest/2017/B50/KernAg_CDFAapnTRS_Pest2017_B50.shp") %>% 
  st_as_sf() 
## Number of organic observations = 680
sum(datawithTRS$organic)

datanoTRS = readOGR("../R_output/spatial/KernAg_CDFA_pest/2017/B50/KernAg_CDFA_Pest2017_B50.shp") %>% 
  st_as_sf()
## Number of organic observations = 333
sum(datanoTRS$CDFA)

# 8531 before TRS match?
# 8519 After TRS match -- The is likely from removing the 18 ros that were mismatches, but should check

summary(data)
```


# Explore data by crop type and organic/conventional
```{r find_top_crops}
topCrops_df = data %>% 
  as.data.frame() %>% # Convert to data.frame
  dplyr::select(-geometry) %>% # Remove geometry column
  group_by(comm_dt) %>% # Group by COMM column
  summarise(total_orgFields = sum(organic)) %>% # Sum the CDFA column. This tells us how many organic fields of each crop type there are
  arrange(-total_orgFields)

comparison_crops = subset(topCrops_df, total_orgFields>4) %>%  # Create a new vector with names of crops with at least five fields
  dplyr::select(1) 

comparison_crops = comparison_crops$comm_dt
comparison_crops # Display in an Rmarkdown document

data$KgAIperHe = data$KgPstAI/data$HE
## 8531 observations before excluding outliers
```

# Look for outliers in data

## All crops combined
```{r all_crops_outliers}

par(mfrow=c(2,3))
hist(data$KgAIperHe[data$CDFA==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$CDFA==1],main = "orgs")
boxplot(data$KgAIperHe[data$CDFA==1],main="orgs")

hist(data$KgAIperHe[data$CDFA==0],
    main = "conv",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$CDFA==0],main = "conv")
boxplot(data$KgAIperHe[data$CDFA==0],main="conv")


```


## By Crop Type
```{r by_crop_outliers}
# Organic
ggplot(subset(data,CDFA == 1&COMM_nw%in%comparison_crops), aes(x = KgAIperHe))+
  geom_histogram()+
  facet_wrap(~COMM_nw,scales = "free")+
  theme_bw()

ggplot(subset(data,CDFA == 1&COMM_nw%in%comparison_crops), aes(sample  = KgAIperHe)) +
  geom_qq() +
  facet_wrap(~COMM_nw,scales = "free") +
  theme_bw()

# Conventional
ggplot(subset(data,CDFA == 0), aes(x = KgAIperHe))+
  geom_histogram()+
  facet_wrap(~COMM_nw,scales = "free")+
  theme_bw()

ggplot(subset(data,CDFA == 0), aes(sample  = KgAIperHe)) +
  geom_qq() +
  facet_wrap(~COMM_nw,scales = "free") +
  theme_bw()
```

### CARROTS
```{r carrots}
crop = 'CARROT'

par(mfrow = c(2,3))

hist(data$KgAIperHe[data$COMM_nw == crop &data$CDFA==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
       main = "orgs")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
        main="orgs")

hist(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
       main = "conv")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
        main = "conv")

# Remove carrot outliers
# data = data[!(data$CDFA == 1 & data$KgAIperHe>1000 & data$COMM_nw == crop),]

## 8529
```

### CABBAGE
```{r cabbage}
crop = 'CABBAGE'

par(mfrow = c(2,3))

hist(data$KgAIperHe[data$COMM_nw == crop &data$CDFA==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
       main = "orgs")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
        main="orgs")

hist(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
       main = "conv")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
        main = "conv")

# Remove carrot outliers
# data = data[!(data$CDFA == 1 & data$KgAIperHe>8 & data$COMM_nw == "CABBAGE"),]
# data = data[!(data$CDFA == 0 & data$KgAIperHe>20 & data$COMM_nw == "CABBAGE"),]

# 8527
```

### ORANGES
```{r oranges}
crop = 'ORANGE'

par(mfrow = c(2,3))

hist(data$KgAIperHe[data$COMM_nw == crop &data$CDFA==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
       main = "orgs")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
        main="orgs")

hist(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
       main = "conv")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
        main = "conv")

# Remove Lemon outliers
# data = data[!(data$CDFA == 1 & data$KgAIperHe>200 & data$COMM_nw == "ORANGE"),]
# data = data[!(data$CDFA == 0 & data$KgAIperHe>500 & data$COMM_nw == "ORANGE"),]

# 8524
```


### GARLIC
```{r garlic}
crop = 'GARLIC'

par(mfrow = c(2,3))

hist(data$KgAIperHe[data$COMM_nw == crop &data$CDFA==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
       main = "orgs")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
        main="orgs")

hist(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
       main = "conv")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
        main = "conv")

# Remove GARLIC outliers
# data = data[!(data$CDFA == 1 & data$KgAIperHe>60 & data$COMM_nw == "GARLIC"),]
# data = data[!(data$CDFA == 0 & data$KgAIperHe>15 & data$COMM_nw == "GARLIC"),]

```


### SPINACH
```{r spinach}
crop = 'SPINACH'

par(mfrow = c(2,3))

hist(data$KgAIperHe[data$COMM_nw == crop &data$CDFA==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
       main = "orgs")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
        main="orgs")

hist(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
       main = "conv")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
        main = "conv")

# Remove Lemon outliers
# data = data[!(data$CDFA == 1 & data$KgAIperHe>50 & data$COMM_nw == "SPINACH"),]

```

### LETTUCE LEAF
```{r lettuce}
crop = 'LETTUCE'

par(mfrow = c(2,3))

hist(data$KgAIperHe[data$COMM_nw == crop & data$CDFA==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
       main = "orgs")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
        main="orgs")

hist(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
    breaks = 30,
    main = "conv",
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
       main = "conv")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
        main = "conv")

# Remove Lettuce outliers
# data = data[!(data$CDFA == 1 & data$KgAIperHe>60 & data$COMM_nw == "LETTUCE"),]
# data = data[!(data$CDFA == 0 & data$KgAIperHe>60 & data$COMM_nw == "LETTUCE"),]

```

### GRAPES
```{r grape}
crop = 'GRAPE'
par(mfrow = c(2,3))

hist(data$KgAIperHe[data$COMM_nw == crop &data$CDFA==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
       main = "orgs")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
        main="orgs")

hist(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
    main = "conv",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
       main = "conv")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
        main = "conv")


```

### POTATO
```{r potato}
crop = 'POTATO'
par(mfrow = c(2,3))

hist(data$KgAIperHe[data$COMM_nw == crop &data$CDFA==1],
    main = "orgs",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
       main = "orgs")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==1],
        main="orgs")

hist(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
    main = "conv",
    breaks = 30,
    xlab = "")
qqnorm(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
       main = "conv")
boxplot(data$KgAIperHe[data$COMM_nw==crop&data$CDFA==0],
        main = "conv")

# Remove potato outliers
# data = data[!(data$CDFA == 1 & data$KgAIperHe>15 & data$COMM_nw == "POTATO"),]
# data = data[!(data$CDFA == 0 & data$KgAIperHe>1500 & data$COMM_nw == "POTATO"),]

```

# Explore data by COMM_grp
```{r comm_group_outliers}

# Fruit
group = "FRUIT"

par(mfrow=c(2,3))
boxplot(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")
qqnorm(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")
hist(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")

boxplot(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")
qqnorm(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")
hist(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")

# data = data[!(data$CDFA == 1 & data$KgAIperHe>1500 & data$COMM_GR == "FRUIT"),]

# Vegetables
group = "VEGETABLE"

par(mfrow=c(2,3))
boxplot(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")
qqnorm(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")
hist(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")

boxplot(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")
qqnorm(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")
hist(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")

# data = data[!(data$CDFA == 1 & data$KgAIperHe>400 & data$COMM_GR == "VEGETABLE"),]


# CITRUS
group = "CITRUS"

par(mfrow=c(2,3))
boxplot(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")
qqnorm(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")
hist(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")

boxplot(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")
qqnorm(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")
hist(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")

# data = data[!(data$CDFA == 0 & data$KgAIperHe>400 & data$COMM_GR == "CITRUS"),]


# NUTS
group = "NUTS"

par(mfrow=c(2,3))
boxplot(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")
qqnorm(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")
hist(data$KgAIperHe[data$COMM_GR==group&data$CDFA==0], main = "conv")

boxplot(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")
qqnorm(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")
hist(data$KgAIperHe[data$COMM_GR==group&data$CDFA==1], main = "org")

```

## Remove cases from conventional fields that seem fishy because the word "Organic" is indiciated somewhere in the name.
```{r fishy_conventional}

data$PERMITT = as.character(data$PERMITT) # Put the Permittee column in character format
data = data[!(data$CDFA == 0&str_detect(data$PERMITT,"ORGANIC")),] # Remove observations that contain the word "organic" in the permittee column

```


## Write output shapefile
```{r write_output}

data_shp = as(data,"Spatial")

writeOGR(data_shp,
           "../R_output/spatial/KernAg_CDFA_pest/2017/FINAL",
           "KernAg_CDFA_Pest_FINAL",
           driver = "ESRI Shapefile",
           overwrite_layer = TRUE)

```

