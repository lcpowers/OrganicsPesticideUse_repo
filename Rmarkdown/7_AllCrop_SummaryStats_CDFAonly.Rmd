---
title: "All Crop Summary Stats -- CDFA Organics"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**The purpose of this Rmarkdown file is to look at descriptive statistics of all crop fields in Kern County, to get a broad overview of differences between conventional and organic agriculture fields. Values for the following categories are determined and put into an output table: **  

      * Total number of fields (total_fields)
      * Total hectares (total_hectares)
      * Average Field Size (average_field_size)
      * Average Soil Quality based on the soil_q Index Rating (average_soilQ)
      * Total Active Ingredient/Pesticide Application (total_pest_app)
      * Average Kg per hectare application of active ingredients (kg_per_hectare)

***

Notes:

- This document and output are the same as in "7b_Allcdfa_organics_SummaryStats", except that the input for this file *only includes* organic fields identified by the CDFA APN *NOT* Kern Ag Shapefile attribute table ("ORGANIC" in the comm name)

#### 1. Load packages, set working directory, and prevent scientific notation
```{r packages_settings}

library(rgdal)
library(sf)
library(tidyverse)
library(reshape2)

# options(scipen = 9999)
# setwd("~/Desktop/Organics_Final/Working/R_files/Rmarkdown")
```

#### 2. Read in full shapefile 
```{r read_in_shapefiles}

organics_shp = readOGR("../R_output/spatial/final_organics_data/all_years/all_years_organics.shp")

```

#### 3. Find organic crop types that have at least 10 fields/sites and 10 conventional fields of the same crop in 2017
```{r top_organic_crops}

yr = 2017

top_crops_df = organics_shp %>% 
  as.data.frame() %>% # Convert to data.frame
  filter(year == yr) %>% 
  group_by(comm_dt) %>% # Group by COMM column
  summarise(total_fields = n(),
            total_orgFields = sum(cdfa_rg),
            total_convFields = n() - sum(cdfa_rg)) %>% # Sum the CDFA column. This tells us how much organic fields of each crop type there are
  arrange(-total_orgFields) %>% # Sort the table in descending order of number of fields per crop type
  filter(total_orgFields >= 10 & total_convFields >= 10) # Get rid of crops with fewer than ten organic fields

comparison_crops = as.character(top_crops_df$comm_dt) # Create a new vector with names of crops with at least ten fields
comparison_crops # Display in an Rmarkdown document
```

#### 4. Summary stats of all fields, conventional or organic, that contain one of the 19 crops listed above
```{r all_fields}

years = 2013:2017

for(i in years){
    
     tmp = organics_shp %>% 
       as.data.frame() %>% 
       filter(year == i) %>% 
       filter(comm_dt %in% comparison_crops) %>% 
       summarise(total_fields = n(),
                 total_hectares = round(sum(acres*0.405/N_crops),1),
                 avg_field_size = round(mean(acres*0.405/N_crops),1),
                 avg_SoilQ = mean(sl_qlty, na.rm = T),
                 total_pest_app = sum(KgPstAI),
                 avg_kg_per_hectare = sum(KgPstAI)/sum(acres*0.405/N_crops))
     
     assign(paste0("all_",i,"_SumStats"),tmp)
     
  }

```

#### 5. Organic Field Summary Stats
```{r org_sum_stats}
for(i in years){
    
     tmp = organics_shp %>% 
       as.data.frame() %>% 
       filter(year == i) %>% 
       filter(comm_dt %in% comparison_crops) %>% 
       filter(cdfa_rg == "1") %>% 
       summarise(total_fields = n(),
                 total_hectares = round(sum(acres*0.405/N_crops),1),
            avg_field_size = round(mean(acres*0.405/N_crops),1),
            avg_SoilQ = mean(sl_qlty, na.rm = T),
            total_pest_app = sum(KgPstAI),
            avg_kg_per_hectare = sum(KgPstAI)/sum(acres*0.405/N_crops))
     
     assign(paste0("Organic_",i,"_SumStats"),tmp)
     
}

```

#### 6. Conventional Field Summary Stats
```{r conv_sum_stats}
for(i in years){
    
     tmp = organics_shp %>% 
       as.data.frame() %>% 
       filter(year == i) %>%
       filter(comm_dt %in% comparison_crops) %>% 
       filter(cdfa_rg == "0") %>% 
       summarise(total_fields = n(),
                 total_hectares = round(sum(acres*0.405/N_crops),1),
            avg_field_size = round(mean(acres*0.405/N_crops),1),
            avg_SoilQ = mean(sl_qlty, na.rm = T),
            total_pest_app = sum(KgPstAI),
            avg_kg_per_hectare = sum(KgPstAI)/sum(acres*0.405/N_crops))
     
     assign(paste0("Conv_",i,"_SumStats"),tmp)
     
  }
```

#### 7. Combine summary tables into one. Remove '#' to write output CSV
```{r combine_and_output}
years=2013:2017

for(i in years){
    
        tmp = rbind(
                 eval(as.name(paste0("all_",i,"_SumStats"))),
                 eval(as.name(paste0("Conv_",i,"_SumStats"))),
                 eval(as.name(paste0("Organic_",i,"_SumStats")))
                 )
     
     rownames(tmp) = c("All_50","Conv_50","Org_50")
     assign(paste0("allFields_",i,"_Summary"),tmp)
     
     dir.create("../R_output/CSV/SummaryStatistics/")
     
     write_csv(tmp,paste0("../R_output/CSV/SummaryStatistics/AllFields_summary_",i,".csv"))
        remove(tmp)
}
```

