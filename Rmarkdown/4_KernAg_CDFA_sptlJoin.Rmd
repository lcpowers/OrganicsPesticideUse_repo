---
title: "Kern County Agriculture -- CDFA parcel spatial join"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**The primary purpose of this Rmarkdown file is to identify organic ag fields using 3 approaches:**

1. Spatial join between CDFA APN-identified parcels (from RMD 2) and Kern Ag parcels
2. Spatial join between CDFA PLSS sections (identied by TRS codes in CDFA csv in RMD 2) and Kern Ag parcels, then filter the "PERMITTEE" column of the joined Kern Ag parcels for "ORGANIC"
3. Filtering for the word "ORGANIC" in the "COMM" column in the Kern Ag data attribute table.
     

**Notes:**

* CDFA parcels were determined by formatting APNs reported to the CDFA by growers, then matching the formatted APNs to Kern County Assessor Parcel spatial data on the APN field. 
* Kern County Agriculture parcels are available on the Kern County Website. 
* Polygons in the Kern County Agriculture shapefile and Kern County Parcel shapefile have different dimensions, with Kern Agriculture fields being generally smaller and containing more detailed agriculture information. This spatial join determines and extracts overlapping parcels and maintains the Kern County Agriculture shapefile's polygon dimensions, which gives us more detailed and accurate information about crop fields in Kern County.  
* This Rmarkdown document uses a function in the "4_KernAg_CDFA_Join.R" file. Function variables include:
       * Year (year)
       * Buffer width (buf_width)
       * Two true/false argument for function output

**Output:**

* The function output can be:
       * A joined shapefile that includes all AG parcels and the Kern Ag/CDFA attribute table
       (write_all_shp = TRUE)
       * A joined shapefile that is filtered to only include ag parcels that joined to a CDFA parcel
       (write_cdfa_shp = TRUE)
       
---


#### 1. Load packages, set working diretory, and source function in the KernAg_CDFA_join.R file 
```{r packages_and_function}
library(tidyverse) # General data organization
library(rgdal) # Gdal for R
library(rgeos) # need this for gBuffer
library(sf) # Specific operations on different versions of shapefiles in R
library(raster)

# Set working directory for For Claire's computer
# setwd("~/Projects/Organics/Working/organics_repo/Rmarkdown/")

# Access function in .R document used to join Kern Agriculture and CDFA parcel shapefiles. 
# See the .R file for more information about the function
source("../R/4_KernAg_CDFA_Join.R")
```

#### 2. Implement the function that performs a spatial join between APN-identified CDFA parcels and Kern Agriculture parcels for specific years and desired buffer width. See notes in the following code chunk for more information about buffer widths and how 50m was determined
```{r implement_function, message=FALSE, warning=FALSE}
# Years of interest
years = 2013:2017

# Buffer widths: In the function these are negative and reduce the CDFA field size. 
# A larger buffer results in a more conservative spatial join between the CDFA parcels and 
# Kern County Agriculture Parcels. The fields in each shapefile have different dimensions, and 
# with no buffer applied CDFA fields match to Kern Ag parcels that hardly touch, increasing the 
# risk of false matches. 

# With a 100-meter buffer, the Kern Ag fields that CDFA parcels join to are almost entirely 
# within the CDFA parcels which results in a loss of reasonable matches.

# A 50-meter buffer provides conservative but seemingly accurate matches. 
# Matches were checked by comparing the company and permittee columns in the attribute 
# table of the resulting joined shapefile.

buf_width = c(50)

for(i in years){
  
  for(j in buf_width){
  
    # Create output directory for the output CSV file that lists the CDFA data 
    # with commodities from Kern Ag data attached
    dir.create(paste0("../R_output/CSV/cdfa_kernAg_join/",i),
               recursive = TRUE)
    
    # Create the output directory for the full CDFA_KernAg_join shapefile, no filters applied. 
    dir.create(paste0("../R_output/spatial/CDFA_KernAg_join/",i,"/buffer",j),
               recursive = TRUE)
    
    # Apply the function that is in the KernAg_CDFA_Join.R script
    kernAg_CDFA_joinFun(i, buf_width = j, write_all_shp = T, write_cdfa_shp = T)
 
     }
  }

```

#### 3. Perform spatial join between CDFA TRS-matched sections and Kern Agriculture Parcels -- Extract Ag parcels that overlap with CDFA sections AND contain the word 'organic' in the company name. 
```{r trs_ag_join}

years = 2013:2017

cdfa_orgs_table = matrix(ncol = 4, nrow = 5)
colnames(cdfa_orgs_table) = c("year","apn","trs","total")
cdfa_orgs_table[,1] <- c(2013:2017)

dir.create("../R_output/spatial/final_organics_data/")

for(i in years){
  
  # Read in data produced above. This is the cdfa data joined to kern county parcels on APN, then spatially joined to kern ag data in the above function
  tmp <- readOGR(paste0("../R_output/spatial/CDFA_KernAg_join/",i,"/buffer50/KernAg_CDFA_all_",i,"_B50.shp")) %>%
    st_as_sf()
  
  assign(paste0("cdfa_kern_apn_",i),tmp)
  rm(tmp)
  
  tmp <- readOGR(paste0("../R_output/spatial/KernAg_withSoil/",i,"/KernAg_withSoil_",i,".shp")) %>%
    st_as_sf() %>%
    dplyr::select(PMT_SITE,S_STATUS,COMM,PERMITTEE,AG_TRS)

  assign(paste0("kern_",i),tmp)
  rm(tmp)
  
  # Read in shaepfile of the PLSS Sections that joined to CDFA data on TRS codes. 
  tmp <- readOGR(paste0("../R_output/spatial/CDFA_PLSS_sections/",i,"/cdfa_sections_",i,".shp")) %>% 
    st_as_sf() %>% 
    mutate(trs_match = 1)
  
  assign(paste0("cdfa_sections_",i),tmp)
  rm(tmp)
  
  cdfasection_ag_join <- st_join(eval(as.name(paste0("kern_",i))),
                      eval(as.name(paste0("cdfa_sections_",i))),
                      largest=T)
  
  org_cdfasection_ag = cdfasection_ag_join %>% 
  filter(str_detect(PERMITTEE,"ORGANIC") & trs_match == 1) %>% # Filter for the word 'Organic' in the permittee column
  dplyr::select("permittee" = PERMITTEE,
               company,
               "trs_match" = trs_match)
  
  # Join TRS section data to Kern Ag/CDFA_APN data. 
  apn_trs_organics_join <- st_join(eval(as.name(paste0("cdfa_kern_apn_",i))),
                      org_cdfasection_ag,
                      largest=T,
                      suffix = c(".apn",".trs"))
  
  apn_trs_organics_final = apn_trs_organics_join %>% 
    dplyr::select("permitsite" = PMT_SITE,
         "s_status" = S_STATUS,
         "permittee" = PERMITTEE,
         "comm" = COMM,
         "agroclass" = AGROCLASS,
         "genus" = GENUS,
         "family" = FAMILY,
         "comm_edit"=COMM_new,
         "acres"=ACRES,
         "soil_q"=SOILQ,
         "apn"=CDFA,
         "trs" = trs_match)
  
  
    # Replace NAs with 0s in the trs_match column
    apn_trs_organics_final$trs[is.na(apn_trs_organics_final$trs)] = 0
  
    # Create a binary organic column based on the apn_match and trs_match columns. If either of those indicates that the parcel is   organic then the value in the binary organic column == 1.
    apn_trs_organics_final$cdfa_organic <- ifelse(apn_trs_organics_final$apn==1|apn_trs_organics_final$trs==1, # If APN or TRS organic
                                              1, # put a 1 in the cdfa_organic column
                                              0) # otherwise put a 0
    
    assign(paste0("apn_trs_orgs_",i),apn_trs_organics_final)
    
      # Write Output File
      writeOGR(obj = as(apn_trs_organics_final,"Spatial"),
         dsn = paste0("../R_output/spatial/CDFA_KernAg_join/",i,"/buffer50"),
         layer = paste0("TRSandAPN_organics_",i),
         driver = "ESRI Shapefile",
         overwrite_layer = T)
      
      writeOGR(obj = as(apn_trs_organics_final,"Spatial"),
         dsn = paste0("../R_output/spatial/final_organics_data/",i),
         layer = paste0("TRSandAPN_organics_",i),
         driver = "ESRI Shapefile",
         overwrite_layer = T)
 
     tmp_sum <- data.frame(year = i,
                        apn = sum(apn_trs_organics_final$apn),
                        trs = sum(apn_trs_organics_final$trs),
                        total = sum(apn_trs_organics_final$cdfa_organic))
  
      cdfa_orgs_table = merge(cdfa_orgs_table,tmp_sum)
      rm(tmp_sum)                      
  }

```

4. Identify organic fields based on Kern Ag "COMM" column
```{r COMM_organics}

years = 2013:2017

for(i in years){
  print(i)
  
  tmp = eval(as.name(paste0("apn_trs_orgs_",i)))
  tmp$comm_org = 0
  tmp$comm_org <- ifelse(str_detect(tmp$comm,"ORGANIC"),1,0)
  print(sum(tmp$comm_org))
  
  tmp$all_organic = 0
  tmp$all_organic = ifelse(tmp$comm_org==1|tmp$trs==1|tmp$apn==1,1,0)
  print(sum(tmp$all_organic))
  
 
  
  # Write Output File
  writeOGR(obj = as(tmp,"Spatial"),
           dsn = paste0("../R_output/spatial/CDFA_KernAg_join/",i,"/buffer50"),
           layer = paste0("all_organics_",i),
           driver = "ESRI Shapefile",
           overwrite_layer = T)
  
  writeOGR(obj = as(tmp,"Spatial"),
           dsn = paste0("../R_output/spatial/final_organics_data/",i),
           layer = paste0("all_organics_",i),
           driver = "ESRI Shapefile",
           overwrite_layer = T)
  
   assign(paste0("cdfa_kernComm_orgs_",i),tmp)
   rm(tmp)

}


```





