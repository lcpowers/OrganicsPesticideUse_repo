---
title: "Rasterize Soil Quality (Storie Index) and add to Kern Ag Shapefile, and add agroclasses"
author: "Claire Powers"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**The purpose of this Rmarkdown document is to add soil quality data to the Kern County Agriculture Polygons. Soil Quality data is based on the Storie Index, which is a metric derived from SSURGO soil data. The shapefile was accessed from DataBasin.org**

**Notes:**   

  * This Rmarkdown document uses a function in the "3_Soil_to_KernAg.R" file. The function reads in year-specific Kern County Ag shapefile, then extracts values from the soil raster into each polygon. The final Storie_Index value is the mean of any values that were extracted into the polygon

**Output:**
* Shapefile with Storie Index data added to the Kern Ag shapefile attribute table


#### 1. Load packages, set working directory, and source the Soil_to_KernAg.R file which contains the function that takes rasterized Storie Index data and adds it to the Kern Agriculture Shapefile
```{r get_packages}

library(rgdal) # Gdal for R
library(tidyverse) # General data processing
library(sf) # Need to change 
library(sp) # Need for crs 
library(raster) # Need for rasterize() and extract() functions

# Set working directory for For Claire's computer
# setwd("~/Projects/Organics/Working/organics_repo/Rmarkdown/")

# Bring in function that adds rasterize Storie Index data to Kern Country Agriculture attribute table 
source("../R/3_Soil_to_KernAg.R")
```

#### 2. Preparing the Storie Index Shapefile to be rasterized. The Storie Index data is in factor format and needs to be numeric to be rasterized. This code chunk gives a numeric value to each factor level
```{r prepare_StorieIndex_shapefile}
## Read in Storie Index Soil Info
soil_raw = readOGR("../R_input/spatial/KernSoilDataBasin/KernSoilData_QGISreproj.shp")

## Put into projection that makes it overlap with Kern Ag and ultimately all over spatial data
proj4string(soil_raw) = CRS("+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs")

## Filter to keep only the column with Storie Index information and geometry (Geometry stays by default unless the dataframe is switched to a basic DF and geometries are removed)
soil_sf = st_as_sf(soil_raw) %>% 
  dplyr::select(StorInd)

## Add another column that gives a numeric value to the Storie Index soil rating. NA values given to values that were desginated NA or Not appropriate for SI rating 
soil_sf$SI_number <- ifelse(str_detect(soil_sf$StorInd,"One"),1,
                            ifelse(str_detect(soil_sf$StorInd,"Two"),2,
                                   ifelse(str_detect(soil_sf$StorInd,"Three"),3,
                                          ifelse(str_detect(soil_sf$StorInd,"Four"),4,
                                                 ifelse(str_detect(soil_sf$StorInd,"Five"),5,
                                                        ifelse(str_detect(soil_sf$StorInd,"Six"),6,NA))))))

## Convert soil dataframe back into a shapefile. 
soil_shp = as(soil_sf,"Spatial")
```

#### 3. Rasterize Storie Index column
```{r create_StorieIndex_raster}
# Initialize empty raster
ras = raster() 

# Set the raster extent based on the soil shapefile
extent(ras) = extent(soil_raw) 

# Set raster resolution (meters)
res(ras) = 50 

# Rasterize Storie Index shapefile on the SI_number attribute column
soil_ras = rasterize(x = soil_shp, y = ras, field = "SI_number")

# Define the CRS again
crs(soil_ras) = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
```

#### 4. Use function to add Storie Index raster data to Kern County Ag shapefile attribute table. Function find the mean for polygons with multiple raster values. 
```{r add_StorieIndex_to_AgData}
# Define years to be evaluated
years = 2013:2017

dir.create("../R_output/spatial/KernAg_withSoil/")

### Read in agroclass csv and join to ag_sf ###
agro_class <- read_csv("../R_input/CSV/Kern_AG/comm_subgroups.csv")
colnames(agro_class) <- c("COMM","COMM_EDIT","COMM_CODEOLD","COMM_CODE","GENUS","AGROCLASS","FAMILY")

agro_class$COMM <- as.character(agro_class$COMM)
# agro_class$COMM_CODE<- as.character(agro_class$COMM_CODE)

# Apply function from the 3_SoilQuality_to_KernAg.R file to years specified. See notes in function for more details 
for(i in years){
  
  Soil_to_KernAg_fun(i)
  
}

```



